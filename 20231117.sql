4-- 함수
CREATE OR REPLACE FUNCTION GET_MAJAOR_NAME(IN_MAJOR_NO IN NUMBER)
RETURN VARCHAR2
IS
    --사용할 변수 선언
    NAME VARCHAR2(50);
BEGIN
    --조회된 결과를 변수 NAME에 저장
    SELECT MAJOR_NAME INTO NAME FROM MAJOR WHERE MAJOR_NO = IN_MAJOR_NO;
    RETURN NAME;
END;
SELECT GET_MAJAOR_NAME(2) FROM DUAL;

CREATE OR REPLACE FUNCTION GET_ODD_EVEN(N IN NUMBER)
RETURN VARCHAR2
IS
    MSG VARCHAR2(100);
BEGIN
    IF N = 0 THEN
        MSG := '0입이니다.';
    ELSIF MOD(N,2) = 1 THEN
        MSG := '홀수 입니다.';
    ELSE
        MSG := '짝수입니다.';
    END IF;
    RETURN MSG;
END;

SELECT get_odd_even(3) FROM DUAL;

CREATE OR REPLACE FUNCTION GET_SCORE_GRADE(SCORE IN NUMBER)
RETURN VARCHAR2
AS 
	GRADE VARCHAR2(30) := 'F';
BEGIN
	--성적 등급, A+,A,B+,B,C+,C,D+,D,F
    IF SCORE = 4.5 THEN
        GRADE := 'A+';
    ELSIF SCORE >= 4.0 THEN
        GRADE := 'A';
    ELSIF SCORE >= 3.5 THEN
        GRADE := 'B+';
    ELSIF SCORE >= 3.0 THEN
        GRADE := 'B';
    ELSIF SCORE >= 2.5 THEN
        GRADE := 'C+';
    ELSIF SCORE >= 2.0 THEN
        GRADE := 'C';
    ELSIF SCORE >= 1.5 THEN
        GRADE := 'D+';
    ELSIF SCORE >= 1.0 THEN
        GRADE := 'D';
    ELSE
        GRADE := 'F';
    END IF;    
    
	RETURN GRADE;
END GET_SCORE_GRADE;
/
SELECT GET_SCORE_GRADE(3.6) FROM DUAL;

--학생 정보 출력시
--학번, 이름, 학과명, 평점, 평점, 등급, 성별
SELECT S.STD_NO, S.STD_NAME, M.MAJOR_NAME, S.STD_SCORE, GET_SCORE_GRADE(S.STD_SCORE) AS STD_GRADE, S.GENDER
FROM STUDENT S JOIN MAJOR M ON S.MAJOR_NO = M.MAJOR_NO;

CREATE OR REPLACE FUNCTION TOTAL_NUM(NUM IN NUMBER)
RETURN NUMBER
AS 
	TOTAL NUMBER := 0;
	I NUMBER := 1;
BEGIN
    LOOP 
        TOTAL := TOTAL + I;
        I := I + 1;
        EXIT WHEN I > NUM;
    END LOOP;
    
    TOTAL := 0;
     I := 0;
     
     WHILE(I<=NUM)
        LOOP
            TOTAL := TOTAL + I;
            I := I + 1;
        END LOOP;
        
        TOTAL := 0;
        FOR I IN 1 .. NUM
        LOOP
            
            TOTAL := TOTAL + I;
        END LOOP;
        
 RETURN TOTAL;
END TOTAL_NUM;
/
SELECT TOTAL_NUM(100) FROM DUAL;
/
--자동차 메이커 명을 매개변수로 받아서 해당 자동차의 총 판매 대수를 리턴하는 함수
CREATE OR REPLACE FUNCTION TOTAL_CAR_MAKER_SELL_EA(MAKER IN VARCHAR2)
RETURN NUMBER
IS
    TOTAL_EA NUMBER := 0;
BEGIN
    SELECT SUM(CS.CAR_SELL_EA) INTO TOTAL_EA FROM CAR_SELL CS JOIN CAR C ON CS.CAR_ID = C.CAR_ID
    JOIN CAR_MAKER CM ON C.CAR_MAKER_CODE = CM.CAR_MAKER_CODE
    WHERE CM.CAR_MAKER_NAME = MAKER;
    
    RETURN TOTAL_EA;
END;
/
SELECT CAR_MAKER_NAME, TOTAL_CAR_MAKER_SELL_EA(CAR_MAKER_NAME)  FROM CAR_MAKER;

--------------------------------------------
---트리거
--------------------------------------------
CREATE TABLE DATA_LOG(
	LOG_DATE DATE DEFAULT SYSDATE,
	LOG_DETAIL VARCHAR2(1000)	
);

CREATE OR REPLACE TRIGGER UPDATE_MAJOR
BEFORE
--UPDATE OF MAJOR_NO, MAJOR_NAME ON MAJOR
UPDATE  ON MAJOR
FOR EACH ROW
BEGIN
    INSERT INTO DATA_LOG(LOG_DETAIL) VALUES(:OLD.MAJOR_NO || ' - ' || :NEW.MAJOR_NO || ' , ' ||
    :OLD.MAJOR_NAME || ' - ' || :NEW.MAJOR_NAME);
END;
/
CREATE OR REPLACE TRIGGER INSERT_MAJOR
AFTER
INSERT ON MAJOR
FOR EACH ROW 
BEGIN 
	INSERT INTO DATA_LOG(LOG_DETAIL) 
	VALUES(:NEW.MAJOR_NO || ' , ' || :NEW.MAJOR_NAME);
END;
/
CREATE OR REPLACE TRIGGER DELETE_MAJOR
AFTER 
DELETE ON MAJOR
FOR EACH ROW 
BEGIN 
	INSERT INTO DATA_LOG(LOG_DETAIL) 
	VALUES(:OLD.MAJOR_NO || ' , ' || :OLD.MAJOR_NAME);
END;
/
--학생 테이블 트리거
--수정 및 삭제가 발생했을때 해당 정보를 data_log 테이블 저장
--수정되는 값이나 삭제되는 값을 메세지에 포함
CREATE OR REPLACE TRIGGER UPDATE_STUDENT
AFTER
INSERT OR UPDATE OR DELETE ON STUDENT
FOR EACH ROW    
BEGIN 
    IF INSERTING THEN
        INSERT INTO DATA_LOG(LOG_DETAIL) 
		VALUES(:NEW.STD_NO || ' - ' || :NEW.STD_NAME 
		|| ' - ' || :NEW.STD_SCORE || ' - ' || :NEW.MAJOR_NO || ' - ' || 'INSERT');
    ELSIF DELETING THEN
        INSERT INTO DATA_LOG(LOG_DETAIL) 
		VALUES(:OLD.STD_NO || ' - ' || :OLD.STD_NAME 
		|| ' - ' || :OLD.STD_SCORE || ' - ' || :OLD.MAJOR_NO || ' - ' || 'DELETE');
    ELSE
        INSERT INTO DATA_LOG(LOG_DETAIL) 
		VALUES(:OLD.STD_NO || ' - ' || :OLD.STD_NAME 
		|| ' - ' || :OLD.STD_SCORE || ' - ' || :OLD.MAJOR_NO || ' - ' || '/' ||
		:NEW.STD_NO || ' - ' || :NEW.STD_NAME 
		|| ' - ' || :NEW.STD_SCORE || ' - ' || :NEW.MAJOR_NO || ' - ' || 'UPDATE');    
    END IF;
    
END;
/
---------------------------------------
SET SERVEROUTPUT ON;
--프로시저 기본 예제
--매개변수가 없을때
CREATE OR REPLACE PROCEDURE PROCEDURE_EX1
IS
	TEST_VAR VARCHAR2(1000) := 'AAAA';
BEGIN 
	dbms_output.put_line(TEST_VAR);
END;
/
EXEC PROCEDURE_EX1;
/
--매개변수가 있을때
CREATE OR REPLACE PROCEDURE PROCEDURE_EX2(
    NAME IN VARCHAR2,
    AGE IN NUMBER
)
IS
	TEST_VAR VARCHAR2(1000) := 'AAAA';
BEGIN 
	dbms_output.put_line(TEST_VAR || ' ' || NAME || ' ' || AGE);
    INSERT INTO PERSON VALUES(NAME, AGE);
    COMMIT;
END;
/
EXEC PROCEDURE_EX2('홍길동111',33); 
/
--값을 외부로 전달할려고 할때
CREATE OR REPLACE PROCEDURE PROCEDURE_EX3(
    NUM IN NUMBER,
    RESULT OUT NUMBER
)
IS
	I NUMBER := 0;
    FAC NUMBER := 1;
BEGIN 
	FOR I IN 1 .. NUM
    LOOP
        FAC := FAC * I;
    END LOOP;
    RESULT := FAC;
   
END;
/
DECLARE
    FAC NUMBER;
BEGIN
     PROCEDURE_EX3(5,FAC);
     dbms_output.put_line(FAC);
END;
/
--사용자 Exception 처리
CREATE OR REPLACE PROCEDURE PROCEDURE_EX4(
    NUM IN NUMBER,
    RESULT OUT NUMBER
)
IS
	I NUMBER := 0;
    FAC NUMBER := 1;
    USER_EXCEPTION EXCEPTION;
BEGIN 
    IF NUM = 0 THEN
        RAISE USER_EXCEPTION;
    END IF;
	FOR I IN 1 .. NUM
    LOOP
        FAC := FAC * I;
    END LOOP;
    RESULT := FAC;
    EXCEPTION
        WHEN USER_EXCEPTION THEN
            dbms_output.put_line('0 이상의 값을 넣어야합니다.');    
            RESULT := 0;
END;
/
DECLARE
    FAC NUMBER;
BEGIN
    PROCEDURE_EX4(5,FAC);
     dbms_output.put_line(FAC);
     dbms_output.put_line('END');
END;
/
CREATE OR REPLACE PROCEDURE PROCEDURE_EX5(
    GRADE_NO IN NUMBER,
    GRADE_NAME IN VARCHAR2,
    RESULT OUT NUMBER
)
IS
    USER_EXCEPTION EXCEPTION;
BEGIN 
    INSERT INTO GRADE VALUES(GRADE_NO,GRADE_NAME);
    IF GRADE_NO = 0 THEN
        RAISE USER_EXCEPTION;
    END IF;
    RESULT := 1;
    COMMIT;
    EXCEPTION
        WHEN DUP_VAL_ON_INDEX THEN
            dbms_output.put_line('데이터가 중복되었습니다.');    
            RESULT := 0;
        WHEN USER_EXCEPTION THEN
            dbms_output.put_line('학과번호는 0보다 커야됩니다.');    
            RESULT := 0;
            ROLLBACK; --UPDATE, INSERT, DELETE 한 작업을 취소
END;
/
DECLARE
    RESULT NUMBER;
BEGIN
    PROCEDURE_EX5(0,'DIAMOND',RESULT);
     dbms_output.put_line(RESULT);
     dbms_output.put_line('END');
END;

